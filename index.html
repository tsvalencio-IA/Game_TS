<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ThIAguinho Wii: Kart Multiplayer Fix</title>
    
    <!-- Bibliotecas Essenciais -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FIREBASE (Vers√£o Compat√≠vel) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Russo+One&family=Roboto:wght@300;400;700&display=swap');

        :root {
            --wii-gray: #ececec;
            --wii-shadow: rgba(0,0,0,0.15);
            --wii-blue: #58b4e8;
        }

        body { 
            background-color: var(--wii-gray); 
            margin: 0; overflow: hidden; 
            font-family: 'Roboto', sans-serif; 
            user-select: none; 
            background: radial-gradient(circle at center, #ffffff 0%, #e0e0e0 100%);
            touch-action: none; /* Impede zoom no mobile */
        }

        /* Efeito de TV Antiga */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%);
            background-size: 100% 3px;
        }

        /* WebCam */
        #webcam { 
            position: absolute; bottom: 20px; right: 20px; width: 120px; 
            border-radius: 12px; border: 4px solid white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transform: scaleX(-1); z-index: 50; opacity: 0; transition: opacity 0.5s;
        }

        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }

        /* Interface Wii */
        .wii-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; width: 100vw; position: relative; z-index: 20;
        }

        .channel-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; width: 85%; max-width: 800px;
        }

        .channel {
            background: white; aspect-ratio: 16/9; border-radius: 10px;
            border: 4px solid #ddd; box-shadow: 2px 2px 10px var(--wii-shadow);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s, border-color 0.2s;
        }
        .channel:hover { border-color: var(--wii-blue); transform: scale(1.05); }
        .channel-icon { font-size: 3rem; }
        .channel-title { font-family: 'Chakra Petch'; font-weight: bold; color: #555; text-transform: uppercase; }

        #loading { 
            background: black; z-index: 100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: var(--wii-blue); font-family: 'Russo One'; font-size: 1.5rem; 
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- HARDWARE -->
    <video id="webcam" autoplay playsinline muted></video>
    <div class="crt-overlay"></div>
    <canvas id="game-canvas"></canvas>

    <!-- LOADING -->
    <div id="loading">
        <div style="width: 50px; height: 50px; border: 5px solid #3498db; border-top-color: transparent; border-radius: 50%; animation: spin 1s infinite;"></div>
        <p style="margin-top: 20px;" id="loading-text">LIGANDO SISTEMA...</p>
    </div>

    <!-- MENU WII -->
    <div id="menu-screen" class="wii-container hidden">
        <div style="width: 90%; display: flex; justify-content: space-between; margin-bottom: 20px; color: #888;">
            <span style="font-weight: bold;">thIAguinho Wii</span>
            <span id="clock" style="background: white; padding: 5px 15px; border-radius: 15px;">12:00</span>
        </div>
        <div class="channel-grid" id="channel-grid"></div>
        <div style="margin-top: 30px;">
             <span id="net-status" style="color: #aaa; font-size: 0.8rem;">OFFLINE</span>
        </div>
    </div>

    <!-- HUD JOGO -->
    <div id="game-ui" class="hidden">
        <div id="game-msg" style="position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-family: 'Russo One'; font-size: 50px; color: yellow; text-shadow: 2px 2px 0 #000; z-index: 60; opacity: 0; pointer-events: none; transition: 0.3s; text-align: center; width: 100%;"></div>
        <button onclick="window.System.home()" style="position: fixed; top: 20px; right: 20px; background: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">üè†</button>
        <!-- O Bot√£o Nitro ser√° injetado via JS -->
    </div>

    <!-- GAME OVER -->
    <div id="screen-over" class="wii-container hidden" style="background: rgba(0,0,0,0.9); color: white;">
        <h1 style="font-family: 'Russo One'; font-size: 4rem; color: #e74c3c;">FIM</h1>
        <h2 style="font-family: 'Chakra Petch';">PONTOS: <span id="final-score" style="color: yellow;">0</span></h2>
        <button onclick="window.System.home()" style="margin-top: 30px; padding: 10px 30px; border-radius: 20px; font-weight: bold; cursor: pointer;">VOLTAR</button>
    </div>

    <!-- C√ìDIGO DO SISTEMA UNIFICADO -->
    <script>
        // --- 1. CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyB0ThqhfK6xc8P1D4WCkavhdXbb7zIaQJk",
            authDomain: "thiaguinhowii.firebaseapp.com",
            databaseURL: "https://thiaguinhowii-default-rtdb.firebaseio.com",
            projectId: "thiaguinhowii",
            storageBucket: "thiaguinhowii.firebasestorage.app",
            messagingSenderId: "63695043126",
            appId: "1:63695043126:web:abd6a8ba7792313991b697"
        };

        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                window.DB = firebase.database();
                console.log("üî• Firebase ON");
                document.getElementById('net-status').innerText = "ONLINE üü¢";
                document.getElementById('net-status').style.color = "green";
            }
        } catch (e) { console.error("Firebase Erro:", e); }

        // --- 2. SISTEMA DE √ÅUDIO & GFX ---
        window.Sfx = {
            ctx: null,
            init: () => { 
                window.AudioContext = window.AudioContext || window.webkitAudioContext; 
                if (!window.Sfx.ctx) window.Sfx.ctx = new AudioContext(); 
                if (window.Sfx.ctx.state === 'suspended') window.Sfx.ctx.resume();
            },
            play: (f, t, d, v=0.1) => {
                if(!window.Sfx.ctx) return;
                try {
                    const o = window.Sfx.ctx.createOscillator(); 
                    const g = window.Sfx.ctx.createGain();
                    o.type=t; o.frequency.value=f; 
                    g.gain.setValueAtTime(v, window.Sfx.ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, window.Sfx.ctx.currentTime+d);
                    o.connect(g); g.connect(window.Sfx.ctx.destination); 
                    o.start(); o.stop(window.Sfx.ctx.currentTime+d);
                } catch(e){}
            },
            hover: () => window.Sfx.play(600, 'sine', 0.05, 0.05),
            click: () => window.Sfx.play(800, 'square', 0.1, 0.1),
            crash: () => window.Sfx.play(100, 'sawtooth', 0.5, 0.2),
            skid: () => window.Sfx.play(150, 'square', 0.1, 0.05)
        };

        window.Gfx = {
            shake: 0,
            updateShake: (ctx) => {
                if(window.Gfx.shake > 0) {
                    ctx.translate((Math.random()-0.5)*window.Gfx.shake, (Math.random()-0.5)*window.Gfx.shake);
                    window.Gfx.shake *= 0.9;
                    if(window.Gfx.shake < 0.5) window.Gfx.shake = 0;
                }
            },
            shakeScreen: (i) => { window.Gfx.shake = i; },
            map: (pt, w, h) => ({ x: (1 - (pt.x / 640)) * w, y: (pt.y / 480) * h }) // Corre√ß√£o de espelhamento e escala
        };

        // --- 3. SYSTEM CORE ---
        window.System = {
            video: null, canvas: null, detector: null,
            games: [], activeGame: null, loopId: null, playerId: null,

            init: async () => {
                const loadingText = document.getElementById('loading-text');
                
                // ID do Jogador
                let savedId = localStorage.getItem('wii_player_id');
                if (!savedId) {
                    savedId = 'P' + Math.floor(Math.random() * 999);
                    localStorage.setItem('wii_player_id', savedId);
                }
                window.System.playerId = savedId;

                try {
                    window.System.canvas = document.getElementById('game-canvas');
                    window.System.resize();
                    window.addEventListener('resize', window.System.resize);

                    // C√¢mera
                    loadingText.innerText = "LIGANDO C√ÇMERA...";
                    window.System.video = document.getElementById('webcam');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 640, height: 480, frameRate: { ideal: 30 } } 
                    });
                    window.System.video.srcObject = stream;
                    await new Promise(r => window.System.video.onloadedmetadata = r);
                    window.System.video.play();

                    // Pose Detection
                    if (typeof poseDetection !== 'undefined') {
                        loadingText.innerText = "CARREGANDO IA...";
                        window.System.detector = await poseDetection.createDetector(
                            poseDetection.SupportedModels.MoveNet, 
                            { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
                        );
                        console.log("IA Pronta!");
                    }
                } catch (e) {
                    console.error("Erro System:", e);
                    loadingText.innerText = "ERRO: C√ÇMERA/IA";
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                    window.System.menu();
                    document.body.addEventListener('click', () => window.Sfx.init(), {once:true});
                    document.body.addEventListener('touchstart', () => window.Sfx.init(), {once:true});
                }
            },

            registerGame: (id, title, icon, logic, opts) => {
                if(!window.System.games.find(g => g.id === id)) {
                    window.System.games.push({ id, title, icon, logic, opts });
                    const grid = document.getElementById('channel-grid');
                    const div = document.createElement('div');
                    div.className = 'channel';
                    div.innerHTML = `<div class="channel-icon">${icon}</div><div class="channel-title">${title}</div>`;
                    div.onclick = () => window.System.loadGame(id);
                    div.onmouseenter = window.Sfx.hover;
                    grid.appendChild(div);
                }
            },

            menu: () => {
                window.System.stopGame();
                document.getElementById('menu-screen').classList.remove('hidden');
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('screen-over').classList.add('hidden');
                document.getElementById('webcam').style.opacity = 0;
                
                const ctx = window.System.canvas.getContext('2d');
                ctx.fillStyle = "#ececec"; ctx.fillRect(0,0, window.System.canvas.width, window.System.canvas.height);
            },

            loadGame: (id) => {
                const game = window.System.games.find(g => g.id === id);
                if(!game) return;
                window.System.activeGame = game;
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                
                if (window.System.video) document.getElementById('webcam').style.opacity = game.opts.camOpacity || 0.3;
                if (game.logic.init) game.logic.init();
                window.Sfx.click();
                window.System.loop();
            },

            loop: async () => {
                if(!window.System.activeGame) return;
                
                const ctx = window.System.canvas.getContext('2d');
                const w = window.System.canvas.width;
                const h = window.System.canvas.height;
                
                let pose = null;
                if (window.System.detector && window.System.video && window.System.video.readyState === 4) {
                    try {
                        const p = await window.System.detector.estimatePoses(window.System.video, {flipHorizontal: false});
                        if(p.length > 0) pose = p[0];
                    } catch(e) {}
                }

                ctx.save();
                window.Gfx.updateShake(ctx);
                const s = window.System.activeGame.logic.update(ctx, w, h, pose);
                ctx.restore();

                window.System.loopId = requestAnimationFrame(window.System.loop);
            },

            stopGame: () => {
                if (window.System.activeGame && window.System.activeGame.logic.cleanup) window.System.activeGame.logic.cleanup();
                window.System.activeGame = null;
                if(window.System.loopId) cancelAnimationFrame(window.System.loopId);
            },

            home: () => { window.Sfx.click(); window.System.menu(); },
            gameOver: (s) => {
                window.System.stopGame(); window.Sfx.crash();
                document.getElementById('final-score').innerText = s;
                document.getElementById('game-ui').classList.add('hidden');
                document.getElementById('screen-over').classList.remove('hidden');
            },
            resize: () => {
                if(window.System.canvas) {
                    window.System.canvas.width = window.innerWidth;
                    window.System.canvas.height = window.innerHeight;
                }
            },
            msg: (t) => {
                const el = document.getElementById('game-msg');
                if(el) { el.innerText = t; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0, 2000); }
            }
        };

        // --- 4. GAME KART LOGIC (FIXED) ---
        (function() {
            const CHARACTERS = [
                { id: 0, name: 'OTTO', color: '#e74c3c', speed: 1.0, turn: 1.0 },
                { id: 1, name: 'SPEED', color: '#f1c40f', speed: 1.1, turn: 0.8 },
                { id: 2, name: 'TANK', color: '#3498db', speed: 0.9, turn: 1.2 }
            ];
            const TRACKS = [
                { id: 0, name: 'GP CIRCUITO', theme: 'grass', sky: 0, curv: 1.0 },
                { id: 1, name: 'DESERTO SECO', theme: 'sand', sky: 1, curv: 0.8 }
            ];
            // Configura√ß√µes de Velocidade Aumentadas
            const CONF = { 
                MAX: 460, // Era 235
                ACCEL: 0.08, // Era 0.075
                FRICTION: 0.98, 
                SEG_LEN: 200 
            };

            let segments = [], minimap = [], particles = [], nitroBtn = null, trackLen = 0;

            const Logic = {
                state: 'MODE_SELECT', roomId: 'room_01',
                charId: 0, trackId: 0, isOnline: false, isReady: false,
                dbRef: null, lastSync: 0, rivals: [], autoStartTimer: null,

                speed: 0, pos: 0, x: 0, steer: 0, nitro: 100, turbo: false,
                lap: 1, maxLaps: 3, rank: 1, score: 0,
                
                virtualWheel: { x:0, y:0, r:0, op:0 },
                handLeft: null, handRight: null, detected: false,

                init: function() {
                    this.state = 'MODE_SELECT'; 
                    this.speed = 0; this.pos = 0; this.x = 0; this.nitro = 100;
                    this.setupUI();
                    window.System.msg("SELECIONE O MODO");
                },

                cleanup: function() {
                    if(this.dbRef) this.dbRef.child('players').off();
                    if(nitroBtn) nitroBtn.remove();
                    window.System.canvas.onclick = null;
                },

                setupUI: function() {
                    const old = document.getElementById('nitro-btn-kart');
                    if(old) old.remove();
                    nitroBtn = document.createElement('div');
                    nitroBtn.id = 'nitro-btn-kart';
                    nitroBtn.innerHTML = "NITRO";
                    Object.assign(nitroBtn.style, {
                        position: 'absolute', top: '40%', right: '20px', width: '80px', height: '80px',
                        borderRadius: '50%', background: 'radial-gradient(#ffaa00, #cc5500)', border: '4px solid #fff',
                        color: '#fff', display: 'none', alignItems: 'center', justifyContent: 'center',
                        fontWeight: 'bold', zIndex: '100', boxShadow: '0 0 15px orange'
                    });
                    
                    const hitTurbo = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        if(this.state === 'RACE' && this.nitro > 10) {
                            this.turbo = !this.turbo;
                            nitroBtn.style.transform = this.turbo ? 'scale(0.9)' : 'scale(1)';
                        }
                    };
                    nitroBtn.addEventListener('touchstart', hitTurbo);
                    nitroBtn.addEventListener('mousedown', hitTurbo);
                    document.getElementById('game-ui').appendChild(nitroBtn);

                    window.System.canvas.onclick = (e) => {
                        const h = window.System.canvas.height;
                        const y = e.clientY;
                        
                        if(this.state === 'MODE_SELECT') {
                            if(y < h/2) this.setMode(false); else this.setMode(true);
                        } else if(this.state === 'LOBBY') {
                            if(y > h * 0.7) this.toggleReady();
                            else if (y < h * 0.3) this.charId = (this.charId + 1) % CHARACTERS.length;
                            else this.trackId = (this.trackId + 1) % TRACKS.length;
                            if(this.isOnline) this.sync();
                        }
                    };
                },

                setMode: function(online) {
                    this.isOnline = online;
                    if(online && window.DB) {
                        this.dbRef = window.DB.ref('rooms/' + this.roomId);
                        const pRef = this.dbRef.child('players/' + window.System.playerId);
                        pRef.set({ name: 'P1', charId: 0, ready: false, lastSeen: Date.now() });
                        pRef.onDisconnect().remove();

                        this.dbRef.child('players').on('value', sn => {
                            const val = sn.val();
                            if(!val) return;
                            const now = Date.now();
                            this.rivals = Object.keys(val)
                                .filter(k => k !== window.System.playerId && (now - val[k].lastSeen < 15000))
                                .map(k => ({ id: k, ...val[k], isRemote: true, color: CHARACTERS[val[k].charId||0].color }));
                            
                            this.checkStart(this.rivals.length + 1);
                        });
                        this.state = 'LOBBY';
                        window.System.msg("CONECTANDO...");
                    } else {
                        this.rivals = [{pos: 500, lap: 1, x: -0.5, speed: 0, color: '#2ecc71', name: 'CPU'}];
                        this.state = 'LOBBY';
                        window.System.msg("OFFLINE");
                    }
                },

                sync: function() {
                    if(!this.isOnline) return;
                    this.dbRef.child('players/' + window.System.playerId).update({
                        charId: this.charId, trackId: this.trackId, ready: this.isReady,
                        pos: Math.floor(this.pos), x: this.x, lap: this.lap,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                },

                toggleReady: function() {
                    this.isReady = !this.isReady;
                    if(this.isReady && !this.isOnline) this.startRace();
                    else if(this.isReady) { this.state = 'WAITING'; window.System.msg("AGUARDANDO..."); }
                    else this.state = 'LOBBY';
                    if(this.isOnline) this.sync();
                },

                checkStart: function(total) {
                    if(this.state !== 'WAITING') return;
                    let ready = (this.isReady ? 1 : 0) + this.rivals.filter(r=>r.ready).length;
                    if(total > 1 && ready === total) this.startRace();
                },

                startRace: function() {
                    this.state = 'RACE';
                    this.buildTrack();
                    nitroBtn.style.display = 'flex';
                    window.System.msg("VAI!!");
                },

                buildTrack: function() {
                    segments = [];
                    const trk = TRACKS[this.trackId];
                    const add = (n, c, y) => {
                        for(let i=0; i<n; i++) segments.push({ 
                            c: c * trk.curv, y: y, 
                            col: Math.floor(segments.length/3)%2 ? 'dark' : 'light' 
                        });
                    };
                    add(50, 0, 0); add(30, 1.5, 0); add(30, -1.5, 0); add(50, 0, 0);
                    add(40, 2.5, 0); add(40, -2.5, 0); add(100, 0, 0);
                    trackLen = segments.length * CONF.SEG_LEN;
                },

                update: function(ctx, w, h, pose) {
                    if(this.state === 'MODE_SELECT') return this.renderMenu(ctx, w, h);
                    if(this.state === 'LOBBY' || this.state === 'WAITING') return this.renderLobby(ctx, w, h);

                    // --- INPUT & F√çSICA ---
                    // Detecta m√£os mesmo se parado
                    let pL = null, pR = null;
                    this.detected = false;
                    
                    if(pose && pose.keypoints) {
                        const lw = pose.keypoints.find(k=>k.name==='left_wrist');
                        const rw = pose.keypoints.find(k=>k.name==='right_wrist');
                        if(lw && lw.score > 0.2) pL = window.Gfx.map(lw, w, h);
                        if(rw && rw.score > 0.2) pR = window.Gfx.map(rw, w, h);
                        if(pL || pR) this.detected = true;
                    }

                    // Controle Volante
                    let targetSteer = 0;
                    if(pL && pR) {
                        this.virtualWheel = { x: (pL.x+pR.x)/2, y: (pL.y+pR.y)/2, r: 50, op: 1 };
                        const ang = Math.atan2(pR.y - pL.y, pR.x - pL.x);
                        if(Math.abs(ang) > 0.1) targetSteer = ang * 2.5;
                    } else {
                        // Modo Fantasma (Sem m√£os)
                        this.virtualWheel.x += (w/2 - this.virtualWheel.x)*0.1;
                        this.virtualWheel.y += (h*0.8 - this.virtualWheel.y)*0.1;
                        this.virtualWheel.op = 0.4; // Mant√©m vis√≠vel mas transparente
                    }
                    this.steer += (targetSteer - this.steer) * 0.2;

                    // Velocidade
                    const char = CHARACTERS[this.charId];
                    let maxS = CONF.MAX * char.speed;
                    if(this.turbo && this.nitro > 0) { maxS *= 1.5; this.nitro -= 0.5; }
                    else { this.nitro = Math.min(100, this.nitro + 0.1); this.turbo = false; }
                    
                    // Acelera automaticamente no mobile se detectar m√£os, ou sempre no PC se quiser
                    const hasGas = this.detected || this.turbo; 
                    if(hasGas && this.state === 'RACE') this.speed += (maxS - this.speed) * CONF.ACCEL;
                    else this.speed *= CONF.FRICTION;

                    // Movimento X
                    const segIdx = Math.floor(this.pos / CONF.SEG_LEN);
                    const seg = segments[segIdx % segments.length] || segments[0];
                    const pct = this.speed / CONF.MAX;
                    
                    this.x += (this.steer * 0.2 * pct) - (seg.c * pct * 0.25); // For√ßa centr√≠fuga
                    
                    // Colis√£o Lateral
                    if(this.x < -2.5) { this.x = -2.5; this.speed *= 0.9; }
                    if(this.x > 2.5) { this.x = 2.5; this.speed *= 0.9; }
                    if(Math.abs(this.x) > 2) { this.speed *= 0.95; window.Gfx.shakeScreen(3); }

                    // Movimento Z
                    this.pos += this.speed;
                    if(this.pos >= trackLen) {
                        this.pos -= trackLen; this.lap++;
                        if(this.lap > this.maxLaps) { this.state = 'END'; this.speed = 0; window.System.gameOver(this.rank); }
                    }

                    // Sincronia Multiplayer (Envia dados)
                    if(this.isOnline && Date.now() - this.lastSync > 100) {
                        this.lastSync = Date.now();
                        this.sync();
                    }

                    // --- C√ÅLCULO DE RANKING CORRIGIDO ---
                    // Calcula dist√¢ncia absoluta de todos
                    let myDist = (this.lap * trackLen) + this.pos;
                    let myRank = 1;

                    this.rivals.forEach(r => {
                        // Atualiza rivais remotos/locais
                        if(!r.isRemote) { // AI Local
                             r.speed += (CONF.MAX * 0.4 - r.speed) * 0.05;
                             r.pos += r.speed;
                             if(r.pos >= trackLen) { r.pos -= trackLen; r.lap++; }
                        }
                        // Dist√¢ncia do Rival
                        let rDist = (r.lap * trackLen) + r.pos;
                        if(rDist > myDist) myRank++;
                    });
                    this.rank = myRank;

                    this.renderWorld(ctx, w, h);
                    return this.score;
                },

                renderWorld: function(ctx, w, h) {
                    const cx = w/2; const cy = h/2;
                    
                    // C√©u e Ch√£o
                    ctx.fillStyle = '#87CEEB'; ctx.fillRect(0,0,w,h/2);
                    ctx.fillStyle = '#2ecc71'; ctx.fillRect(0,h/2,w,h/2);

                    // Desenha Pista
                    let dx = 0; let camX = this.x * w;
                    let maxDraw = 40;
                    let startIdx = Math.floor(this.pos / CONF.SEG_LEN);
                    
                    for(let n=0; n<maxDraw; n++) {
                        let idx = (startIdx + n) % segments.length;
                        let seg = segments[idx];
                        let loop = Math.floor((startIdx + n) / segments.length);
                        
                        // Proje√ß√£o 3D Simplificada
                        let z1 = (n * CONF.SEG_LEN);
                        let z2 = ((n+1) * CONF.SEG_LEN);
                        let scale1 = 200 / (200 + z1);
                        let scale2 = 200 / (200 + z2);
                        
                        let y1 = h/2 + (500 * scale1); // Altura da c√¢mera
                        let y2 = h/2 + (500 * scale2);
                        
                        dx += seg.c;
                        let x1 = cx - (camX * scale1) - (dx * z1/1000 * w * scale1);
                        let x2 = cx - (camX * scale2) - ((dx + seg.c) * z2/1000 * w * scale2);
                        
                        // Desenha Segmento
                        let w1 = w * 2 * scale1;
                        let w2 = w * 2 * scale2;
                        
                        ctx.fillStyle = seg.col === 'dark' ? '#555' : '#666'; // Asfalto
                        ctx.beginPath();
                        ctx.moveTo(x1-w1, y1); ctx.lineTo(x1+w1, y1);
                        ctx.lineTo(x2+w2, y2); ctx.lineTo(x2-w2, y2);
                        ctx.fill();

                        // Zebras
                        ctx.fillStyle = seg.col === 'dark' ? '#fff' : '#c0392b';
                        ctx.fillRect(x1-w1*1.2, y1, w1*0.2, y2-y1);
                        ctx.fillRect(x1+w1, y1, w1*0.2, y2-y1);

                        // Rivais
                        this.rivals.forEach(r => {
                             // L√≥gica simples de renderizar rivais
                             // Se o rival estiver neste segmento... desenhar
                             let rRel = r.pos - this.pos;
                             if(rRel < 0) rRel += trackLen; // Loop fix
                             
                             let rSegIdx = Math.floor(r.pos / CONF.SEG_LEN);
                             if(rSegIdx === idx) {
                                 let rx = x1 + (r.x * w1);
                                 ctx.fillStyle = r.color;
                                 ctx.beginPath(); ctx.arc(rx, y1 - 20*scale1, 30*scale1, 0, Math.PI*2); ctx.fill();
                             }
                        });
                    }

                    // Desenha Volante (UI)
                    if(this.virtualWheel.op > 0) {
                        const vw = this.virtualWheel;
                        ctx.save();
                        ctx.globalAlpha = vw.op;
                        ctx.translate(vw.x, vw.y);
                        ctx.rotate(this.steer);
                        
                        // Aro
                        ctx.lineWidth = 10; ctx.strokeStyle = '#333';
                        ctx.beginPath(); ctx.arc(0,0, vw.r, 0, Math.PI*2); ctx.stroke();
                        // Centro
                        ctx.fillStyle = CHARACTERS[this.charId].color;
                        ctx.beginPath(); ctx.arc(0,0, 15, 0, Math.PI*2); ctx.fill();
                        // Marcador
                        ctx.fillStyle = 'red'; ctx.fillRect(-5, -vw.r, 10, 20);
                        
                        ctx.restore();
                    }

                    // HUD Texto
                    ctx.fillStyle = "white"; ctx.strokeStyle = "black"; ctx.lineWidth = 3;
                    ctx.font = "bold 40px 'Russo One'";
                    ctx.strokeText(`${this.rank}¬∫`, 20, 50); ctx.fillText(`${this.rank}¬∫`, 20, 50);
                    
                    ctx.font = "20px 'Chakra Petch'";
                    ctx.fillText(`VOLTA ${this.lap}/${this.maxLaps}`, 20, 80);
                    
                    // Barra Nitro
                    ctx.fillStyle = "#333"; ctx.fillRect(w/2 - 100, 20, 200, 20);
                    ctx.fillStyle = this.turbo ? "cyan" : "orange"; 
                    ctx.fillRect(w/2 - 98, 22, 196 * (this.nitro/100), 16);
                },

                renderMenu: function(ctx, w, h) {
                    this.drawBg(ctx, w, h, "ESCOLHA O MODO");
                    this.btn(ctx, w/2, h*0.4, "OFFLINE", "#e67e22");
                    this.btn(ctx, w/2, h*0.6, "ONLINE", "#27ae60");
                },

                renderLobby: function(ctx, w, h) {
                    this.drawBg(ctx, w, h, this.state === 'WAITING' ? "AGUARDANDO..." : "LOBBY");
                    const c = CHARACTERS[this.charId];
                    const t = TRACKS[this.trackId];
                    
                    ctx.font = "30px Arial"; ctx.fillStyle = c.color;
                    ctx.fillText(`PERSONAGEM: ${c.name}`, w/2, h*0.3);
                    ctx.fillStyle = "#aaa"; ctx.fillText(`PISTA: ${t.name}`, w/2, h*0.4);
                    
                    this.btn(ctx, w/2, h*0.7, this.isReady ? "CANCELAR" : "PRONTO!", this.isReady ? "#c0392b" : "#2980b9");
                    
                    ctx.fillStyle = "#fff"; ctx.font="14px monospace"; ctx.textAlign="left";
                    ctx.fillText(`Jogadores: ${this.rivals.length + 1}`, 20, h-20);
                },

                drawBg: function(ctx, w, h, title) {
                    ctx.fillStyle = "#2c3e50"; ctx.fillRect(0,0,w,h);
                    ctx.fillStyle = "white"; ctx.textAlign = "center"; 
                    ctx.font = "bold 40px 'Russo One'"; ctx.fillText(title, w/2, 60);
                },
                btn: function(ctx, x, y, txt, col) {
                    ctx.fillStyle = col; ctx.fillRect(x-150, y-30, 300, 60);
                    ctx.fillStyle = "white"; ctx.font = "bold 25px Arial"; ctx.fillText(txt, x, y+10);
                }
            };

            window.System.registerGame('kart', 'Kart GP', 'üèéÔ∏è', Logic, { camOpacity: 0.2 });
        })();

        // Rel√≥gio
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
        window.onload = window.System.init;
    </script>
</body>
</html>