<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>thIAguinho WII: ARCADE EDITION</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --neon-blue: #00F3FF;
            --neon-pink: #FF0055;
            --neon-green: #00FF9D;
            --neon-yellow: #FFD600;
            --bg-dark: #050505;
        }

        body {
            background-color: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif;
            margin: 0; overflow: hidden;
            touch-action: none; user-select: none; -webkit-user-select: none;
            color: white;
        }

        /* LAYOUT */
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        #game-canvas { position: absolute; inset: 0; z-index: 1; width: 100%; height: 100%; }
        
        /* UI */
        #ui-layer { 
            position: absolute; inset: 0; z-index: 10; pointer-events: none; 
            padding: env(safe-area-inset-top) 20px 40px 20px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .interactive { pointer-events: auto; cursor: pointer; }

        /* CARDS */
        .game-card {
            background: linear-gradient(145deg, rgba(20,20,30,0.9), rgba(10,10,15,0.95));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .game-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: white;
        }
        .game-card:active { transform: scale(0.96); brightness: 1.2; }
        
        /* THEMES */
        .theme-kart::before { background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); }
        .theme-run::before { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .theme-box::before { background: var(--neon-pink); box-shadow: 0 0 10px var(--neon-pink); }

        /* HUD */
        .hud-glass {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* ANIMATIONS */
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scanline { position: absolute; inset: 0; pointer-events: none; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.02), transparent); animation: scanline 4s linear infinite; }
        
        .title-font { font-family: 'Black Ops One', system-ui; }
        .neon-text-blue { text-shadow: 0 0 10px var(--neon-blue); }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div class="scanline"></div>

        <div id="ui-layer">
            
            <!-- MENU PRINCIPAL -->
            <div id="screen-menu" class="absolute inset-0 bg-black/90 backdrop-blur-xl z-50 flex flex-col items-center justify-center interactive p-6 transition-opacity duration-500">
                <div class="mb-10 text-center transform hover:scale-105 transition-transform">
                    <h1 class="text-6xl md:text-8xl text-white title-font tracking-tighter leading-none">
                        th<span class="text-[var(--neon-blue)] neon-text-blue">IA</span>guinho
                    </h1>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <div class="h-px w-8 bg-gray-500"></div>
                        <p class="text-gray-400 text-sm tracking-[0.4em] font-bold">WII ARCADE</p>
                        <div class="h-px w-8 bg-gray-500"></div>
                    </div>
                </div>

                <div class="w-full max-w-sm grid gap-4">
                    <!-- KART -->
                    <div onclick="App.launch('kart')" class="game-card theme-kart h-24 flex items-center px-5 interactive group">
                        <div class="text-4xl mr-5 group-hover:scale-110 transition-transform">üèéÔ∏è</div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-white italic">NITRO KART</h2>
                            <p class="text-xs text-gray-400 font-mono">TOQUE E ARRASTE</p>
                        </div>
                        <div class="text-[var(--neon-blue)] font-black text-xl">GO</div>
                    </div>

                    <!-- RUN -->
                    <div onclick="App.launch('run')" class="game-card theme-run h-24 flex items-center px-5 interactive group">
                        <div class="text-4xl mr-5 group-hover:scale-110 transition-transform">üèÉ</div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-white italic">CYBER RUN</h2>
                            <p class="text-xs text-gray-400 font-mono">DESVIE E PULE</p>
                        </div>
                        <div class="text-[var(--neon-green)] font-black text-xl">GO</div>
                    </div>

                    <!-- BEAT -->
                    <div onclick="App.launch('beat')" class="game-card theme-box h-24 flex items-center px-5 interactive group">
                        <div class="text-4xl mr-5 group-hover:scale-110 transition-transform">ü•ä</div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-white italic">RHYTHM BOX</h2>
                            <p class="text-xs text-gray-400 font-mono">TOQUE NOS ALVOS</p>
                        </div>
                        <div class="text-[var(--neon-pink)] font-black text-xl">GO</div>
                    </div>
                </div>
                
                <div class="mt-8 text-center">
                    <p class="text-[10px] text-gray-600 font-mono">HIGH SCORE: <span id="menu-highscore" class="text-white">0</span></p>
                    <p class="text-[10px] text-gray-700 mt-1">Desenvolvido com ü§ñ por thIAguinho Solu√ß√µes</p>
                </div>
            </div>

            <!-- HUD (IN-GAME) -->
            <div id="screen-hud" class="hidden w-full h-full flex-col justify-between pointer-events-none pb-6">
                <!-- Topo -->
                <div class="flex justify-between items-start w-full">
                    <div class="hud-glass px-5 py-2 flex flex-col items-center min-w-[100px]">
                        <span class="text-[9px] text-[var(--neon-blue)] font-bold uppercase tracking-widest">SCORE</span>
                        <span id="hud-score" class="text-3xl font-mono font-bold text-white leading-none">0</span>
                    </div>
                    
                    <button onclick="App.stop()" class="interactive w-10 h-10 rounded-full bg-red-500/20 border border-red-500 text-red-500 font-bold flex items-center justify-center backdrop-blur active:bg-red-500 active:text-white transition-colors">
                        ‚úï
                    </button>
                </div>

                <!-- Centro (Mensagens) -->
                <div id="hud-msg" class="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                    <h2 id="msg-text" class="text-6xl font-black text-white italic drop-shadow-2xl opacity-0 transition-all duration-200 transform scale-50" style="-webkit-text-stroke: 2px black;"></h2>
                </div>

                <!-- Controles/Status -->
                <div class="w-full flex justify-center">
                    <span id="hud-controls" class="text-[10px] font-bold text-gray-400 bg-black/50 px-4 py-1 rounded-full border border-white/10 uppercase tracking-widest">
                        TOQUE NA TELA PARA JOGAR
                    </span>
                </div>
            </div>

            <!-- GAME OVER -->
            <div id="screen-gameover" class="hidden absolute inset-0 bg-black/95 z-50 flex-col items-center justify-center interactive p-6">
                <h1 class="text-5xl text-red-500 title-font mb-2 tracking-wider">GAME OVER</h1>
                <div class="flex flex-col items-center gap-1 mb-8">
                    <p class="text-gray-500 text-xs uppercase tracking-widest">PONTUA√á√ÉO FINAL</p>
                    <p id="final-score" class="text-7xl font-mono font-bold text-white">0</p>
                </div>
                
                <button onclick="App.showMenu()" class="px-10 py-4 bg-white text-black font-black text-lg rounded-full hover:scale-105 active:scale-95 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.5)]">
                    JOGAR NOVAMENTE
                </button>
            </div>

        </div>
    </div>

    <script>
        /**
         * =========================================================================
         * AUDIO ENGINE (SINTETIZADOR S√îNICO)
         * Gera sons em tempo real sem arquivos externos.
         * =========================================================================
         */
        const AudioSys = {
            ctx: null,
            init: () => {
                if (!AudioSys.ctx) AudioSys.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playTone: (freq, type, duration, vol=0.1) => {
                if (!AudioSys.ctx) return;
                const osc = AudioSys.ctx.createOscillator();
                const gain = AudioSys.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, AudioSys.ctx.currentTime);
                gain.gain.setValueAtTime(vol, AudioSys.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, AudioSys.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(AudioSys.ctx.destination);
                osc.start();
                osc.stop(AudioSys.ctx.currentTime + duration);
            },
            sfx: {
                click: () => AudioSys.playTone(800, 'sine', 0.1),
                start: () => { AudioSys.playTone(400, 'square', 0.1); setTimeout(()=>AudioSys.playTone(600, 'square', 0.2), 100); },
                hit: () => AudioSys.playTone(200 + Math.random()*200, 'triangle', 0.15, 0.2),
                jump: () => AudioSys.playTone(300, 'sine', 0.3),
                crash: () => AudioSys.playTone(100, 'sawtooth', 0.4, 0.3),
                coin: () => AudioSys.playTone(1200, 'sine', 0.1, 0.1)
            }
        };

        /**
         * =========================================================================
         * INPUT ENGINE (TOUCH & MOUSE)
         * =========================================================================
         */
        const Input = {
            x: 0, y: 0,
            active: false,
            tapped: false,
            swipe: { startX: 0, startY: 0, dir: null },

            init: (canvas) => {
                const setPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    Input.x = clientX - rect.left;
                    Input.y = clientY - rect.top;
                };

                // Mouse
                canvas.addEventListener('mousedown', e => { Input.active = true; Input.tapped = true; setPos(e); });
                canvas.addEventListener('mousemove', e => { if(Input.active) setPos(e); });
                canvas.addEventListener('mouseup', () => Input.active = false);

                // Touch
                canvas.addEventListener('touchstart', e => {
                    e.preventDefault();
                    Input.active = true;
                    Input.tapped = true;
                    setPos(e);
                    Input.swipe.startX = Input.x;
                    Input.swipe.startY = Input.y;
                    Input.swipe.dir = null;
                }, {passive: false});

                canvas.addEventListener('touchmove', e => {
                    e.preventDefault();
                    setPos(e);
                }, {passive: false});

                canvas.addEventListener('touchend', e => {
                    Input.active = false;
                    // Detect Swipe
                    const dx = Input.x - Input.swipe.startX;
                    const dy = Input.y - Input.swipe.startY;
                    if (Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)) Input.swipe.dir = dx > 0 ? 'right' : 'left';
                    else if (Math.abs(dy) > 30) Input.swipe.dir = dy > 0 ? 'down' : 'up';
                });
            },
            
            // Consome o evento de tap (clique √∫nico)
            consumeTap: () => {
                if (Input.tapped) { Input.tapped = false; return true; }
                return false;
            },
            
            // Consome o evento de swipe
            consumeSwipe: () => {
                const s = Input.swipe.dir;
                Input.swipe.dir = null;
                return s;
            }
        };

        /**
         * =========================================================================
         * GRAPHICS ENGINE
         * =========================================================================
         */
        const Gfx = {
            canvas: document.getElementById('game-canvas'),
            ctx: null,
            width: 0, height: 0,

            init: () => {
                Gfx.ctx = Gfx.canvas.getContext('2d', { alpha: false });
                window.addEventListener('resize', Gfx.resize);
                Gfx.resize();
            },

            resize: () => {
                Gfx.width = window.innerWidth;
                Gfx.height = window.innerHeight;
                const dpr = window.devicePixelRatio || 1;
                Gfx.canvas.width = Gfx.width * dpr;
                Gfx.canvas.height = Gfx.height * dpr;
                Gfx.ctx.scale(dpr, dpr);
                Gfx.ctx.imageSmoothingEnabled = false;
            },

            clear: (color = '#050505') => {
                Gfx.ctx.fillStyle = color;
                Gfx.ctx.fillRect(0, 0, Gfx.width, Gfx.height);
            }
        };

        /**
         * =========================================================================
         * JOGO 1: NEON KART (Touch Steer)
         * =========================================================================
         */
        class GameKart {
            constructor() {
                this.speed = 0;
                this.carX = 0;
                this.score = 0;
                this.roadCurve = 0;
                this.obstacles = [];
                this.particles = [];
                document.getElementById('hud-controls').innerText = "ARRASTE PARA DIRIGIR";
                AudioSys.sfx.start();
            }

            update(dt) {
                // INPUT
                if (Input.active) {
                    const targetX = ((Input.x / Gfx.width) - 0.5) * 3.0; // Mapeia toque para -1.5 a 1.5
                    this.carX += (targetX - this.carX) * 5 * dt; // Suaviza√ß√£o
                    this.speed = Math.min(200, this.speed + 100 * dt);
                } else {
                    this.speed *= 0.98; // Freio
                }

                this.score += Math.floor(this.speed * dt);
                
                // F√≠sica da Pista
                this.roadCurve = Math.sin(Date.now() / 2000) * 0.8;
                
                // Obst√°culos
                if (Math.random() < 0.02 && this.speed > 50) {
                    this.obstacles.push({ x: (Math.random()-0.5)*2.0, z: 0, color: Math.random()>0.5?'#FF0055':'#FFD600' });
                }

                // Render
                const ctx = Gfx.ctx;
                const w = Gfx.width; const h = Gfx.height;
                Gfx.clear('#02040a');

                // Horizonte e Sol
                const hz = h * 0.35;
                const grad = ctx.createLinearGradient(0,0,0,hz);
                grad.addColorStop(0, '#000'); grad.addColorStop(1, '#1a1a2e');
                ctx.fillStyle = grad; ctx.fillRect(0,0,w,hz);
                
                // Sol
                ctx.fillStyle = '#FF0055'; ctx.beginPath(); ctx.arc(w/2, hz, 40, 0, Math.PI, true); ctx.fill();

                // Pista
                ctx.fillStyle = '#111';
                ctx.beginPath();
                const top = w/2 + (this.roadCurve * 300);
                const bot = w/2 + (this.carX * -400); // Movimento relativo do mundo
                ctx.moveTo(top-5, hz); ctx.lineTo(top+5, hz);
                ctx.lineTo(bot+w, h); ctx.lineTo(bot-w, h);
                ctx.fill();

                // Grid da Pista
                ctx.strokeStyle = 'rgba(0, 243, 255, 0.5)'; ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(top, hz); ctx.lineTo(bot, h); // Linha central
                ctx.stroke();

                // Obst√°culos
                for(let i = this.obstacles.length-1; i>=0; i--) {
                    let o = this.obstacles[i];
                    o.z += (this.speed * 0.003) * dt * 60;
                    if(o.z > 1.2) { this.obstacles.splice(i,1); continue; }

                    const scale = o.z*o.z;
                    const dy = hz + (o.z * (h-hz));
                    const roadX = top + (bot-top) * o.z;
                    const dx = roadX + (o.x * w * 0.8 * o.z);
                    const size = 60 * scale;

                    ctx.fillStyle = o.color;
                    ctx.shadowBlur = 10; ctx.shadowColor = o.color;
                    ctx.fillRect(dx - size/2, dy - size, size, size);
                    ctx.shadowBlur = 0;

                    // Colis√£o
                    if(o.z > 0.9 && o.z < 1.0 && Math.abs(dx - w/2) < 60) {
                        AudioSys.sfx.crash();
                        App.gameOver(this.score);
                    }
                }

                // Carro
                ctx.fillStyle = '#00F3FF';
                ctx.shadowBlur = 20; ctx.shadowColor = '#00F3FF';
                const cx = w/2, cy = h-100;
                // Desenho simples futurista
                ctx.beginPath();
                ctx.moveTo(cx, cy-40); ctx.lineTo(cx+30, cy+20); ctx.lineTo(cx-30, cy+20);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Rodas/Rastro
                ctx.fillStyle = 'rgba(0, 243, 255, 0.5)';
                if(Input.active) ctx.fillRect(cx-25, cy+20, 10, 20 + Math.random()*20);
                if(Input.active) ctx.fillRect(cx+15, cy+20, 10, 20 + Math.random()*20);
            }
        }

        /**
         * =========================================================================
         * JOGO 2: CYBER RUN (Tap to Jump)
         * =========================================================================
         */
        class GameRun {
            constructor() {
                this.score = 0;
                this.speed = 10;
                this.playerY = 0;
                this.jumpVel = 0;
                this.obstacles = [];
                this.particles = [];
                this.lane = 1; // 0, 1, 2
                this.targetLaneX = 0;
                this.x = 0;
                
                document.getElementById('hud-controls').innerText = "TOQUE P/ PULAR ‚Ä¢ DESLIZE P/ LADOS";
                AudioSys.sfx.start();
            }

            update(dt) {
                // INPUT
                const swipe = Input.consumeSwipe();
                if(swipe === 'left' && this.lane > 0) this.lane--;
                if(swipe === 'right' && this.lane < 2) this.lane++;
                if((Input.consumeTap() || swipe === 'up') && this.playerY === 0) {
                    this.jumpVel = 18;
                    this.playerY = 1;
                    AudioSys.sfx.jump();
                }

                // F√≠sica
                this.speed += dt * 2;
                this.score += Math.floor(this.speed * dt * 10);
                
                // Lane Interpolation
                const laneWidth = 100;
                this.targetLaneX = (this.lane - 1) * laneWidth;
                this.x += (this.targetLaneX - this.x) * 10 * dt;

                // Gravidade
                if (this.playerY > 0) {
                    this.playerY += this.jumpVel * dt * 2;
                    this.jumpVel -= 60 * dt;
                    if (this.playerY <= 0) { this.playerY = 0; this.jumpVel = 0; }
                }

                // Obst√°culos
                if (Math.random() < 0.02 + (this.speed*0.0005)) {
                    this.obstacles.push({ lane: Math.floor(Math.random()*3), x: 0, z: 0, type: Math.random()>0.5 ? 'low' : 'high' });
                }

                // RENDER
                const ctx = Gfx.ctx;
                const w = Gfx.width; const h = Gfx.height;
                Gfx.clear('#0d1117');

                const horizon = h * 0.4;
                
                // Floor Grid
                ctx.strokeStyle = '#00FF9D'; ctx.lineWidth = 1; ctx.globalAlpha = 0.3;
                ctx.beginPath();
                const centerX = w/2;
                ctx.moveTo(centerX, horizon); ctx.lineTo(centerX - 300, h);
                ctx.moveTo(centerX, horizon); ctx.lineTo(centerX, h);
                ctx.moveTo(centerX, horizon); ctx.lineTo(centerX + 300, h);
                ctx.stroke();
                ctx.globalAlpha = 1.0;

                // Obst√°culos
                for(let i=this.obstacles.length-1; i>=0; i--) {
                    let o = this.obstacles[i];
                    o.z += (this.speed * 0.01) * dt * 60;
                    if(o.z > 20) { this.obstacles.splice(i,1); continue; }

                    const scale = o.z / 10;
                    const drawY = horizon + (o.z * (h - horizon) * 0.1); // Perspectiva ajustada
                    const laneX = (o.lane - 1) * 100 * scale; 
                    const drawX = w/2 + laneX * 4; // Spread das lanes
                    const size = 40 * scale;

                    if(scale > 0.1) {
                        ctx.fillStyle = o.type === 'low' ? '#FFD600' : '#FF0055';
                        const yOff = o.type === 'high' ? size*2 : 0;
                        ctx.fillRect(drawX - size/2, drawY - size - yOff, size, size);

                        // Colis√£o
                        if(scale > 0.9 && scale < 1.1 && o.lane === this.lane) {
                            const hitLow = o.type === 'low' && this.playerY < 10;
                            const hitHigh = o.type === 'high' && this.playerY > 10;
                            if(hitLow || hitHigh) {
                                AudioSys.sfx.crash();
                                App.gameOver(this.score);
                            }
                        }
                    }
                }

                // Player
                const px = w/2 + (this.x * 4 * 0.1); // Project X based on current Z (which is near camera)
                const py = h - 150 - (this.playerY * 5);
                
                ctx.shadowBlur = 15; ctx.shadowColor = '#00FF9D';
                ctx.fillStyle = '#00FF9D';
                ctx.fillRect(px - 20, py - 40, 40, 40);
                ctx.shadowBlur = 0;
            }
        }

        /**
         * =========================================================================
         * JOGO 3: RHYTHM BOX (Whac-a-Mole Touch)
         * =========================================================================
         */
        class GameBox {
            constructor() {
                this.score = 0;
                this.targets = [];
                this.timer = 0;
                this.spawnRate = 0.8;
                document.getElementById('hud-controls').innerText = "TOQUE R√ÅPIDO NOS ALVOS";
                AudioSys.sfx.start();
            }

            update(dt) {
                // Spawn
                this.timer += dt;
                if(this.timer > this.spawnRate) {
                    this.timer = 0;
                    const size = 40 + Math.random()*20;
                    this.targets.push({
                        x: Math.random() * (Gfx.width - 100) + 50,
                        y: Math.random() * (Gfx.height - 200) + 100,
                        r: 0, maxR: size,
                        color: Math.random()>0.5 ? '#00F3FF' : '#FF0055',
                        state: 'grow'
                    });
                    this.spawnRate = Math.max(0.3, this.spawnRate * 0.99);
                }

                // Input Check
                if(Input.consumeTap()) {
                    let hit = false;
                    // Check reverse loop to hit top targets first
                    for(let i=this.targets.length-1; i>=0; i--) {
                        let t = this.targets[i];
                        const dist = Math.hypot(Input.x - t.x, Input.y - t.y);
                        if(dist < t.r + 20) {
                            // HIT
                            AudioSys.sfx.hit();
                            this.targets.splice(i, 1);
                            this.score += 100;
                            App.showMsg("HIT!", t.color);
                            hit = true;
                            break; // S√≥ um por toque
                        }
                    }
                }

                // Render
                const ctx = Gfx.ctx;
                Gfx.clear('#110011');

                for(let i=this.targets.length-1; i>=0; i--) {
                    let t = this.targets[i];
                    
                    if(t.state === 'grow') {
                        t.r += 100 * dt;
                        if(t.r >= t.maxR) t.state = 'shrink';
                    } else {
                        t.r -= 50 * dt;
                        if(t.r <= 0) {
                            this.targets.splice(i, 1); // Missed
                            App.showMsg("MISS", "#555");
                            continue;
                        }
                    }

                    ctx.beginPath();
                    ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
                    ctx.fillStyle = t.color;
                    ctx.shadowBlur = 15; ctx.shadowColor = t.color;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // Ring
                    ctx.beginPath(); ctx.arc(t.x, t.y, t.maxR, 0, Math.PI*2);
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.stroke();
                }
            }
        }

        /**
         * =========================================================================
         * APP CONTROL
         * =========================================================================
         */
        const App = {
            game: null,
            loopId: null,
            lastTime: 0,

            start: (type) => {
                AudioSys.init(); // User interaction required first
                Input.init(document.getElementById('game-canvas'));
                
                document.getElementById('screen-menu').classList.add('hidden');
                document.getElementById('screen-hud').classList.remove('hidden');
                document.getElementById('screen-hud').classList.add('flex');
                document.getElementById('screen-gameover').classList.add('hidden');

                if(type === 'kart') App.game = new GameKart();
                if(type === 'run') App.game = new GameRun();
                if(type === 'beat') App.game = new GameBox();

                App.lastTime = performance.now();
                App.loop();
            },

            stop: () => {
                cancelAnimationFrame(App.loopId);
                App.game = null;
                document.getElementById('screen-hud').classList.remove('flex');
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
            },

            gameOver: (score) => {
                cancelAnimationFrame(App.loopId);
                App.game = null;
                const highScore = localStorage.getItem('th_highscore') || 0;
                if(score > highScore) localStorage.setItem('th_highscore', score);
                
                document.getElementById('final-score').innerText = score;
                document.getElementById('menu-highscore').innerText = Math.max(score, highScore);
                
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-gameover').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('flex');
            },

            showMenu: () => {
                document.getElementById('screen-gameover').classList.remove('flex');
                document.getElementById('screen-gameover').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                Gfx.clear();
            },

            returnToMenu: () => App.showMenu(),

            showMsg: (txt, color) => {
                const el = document.getElementById('msg-text');
                el.innerText = txt; el.style.color = color;
                el.style.opacity = 1; el.style.transform = "scale(1.5)";
                setTimeout(() => { el.style.opacity = 0; el.style.transform = "scale(1)"; }, 400);
            },

            loop: (now) => {
                if(!App.game) return;
                const dt = Math.min((now - App.lastTime) / 1000, 0.1);
                App.lastTime = now;

                App.game.update(dt);
                document.getElementById('hud-score').innerText = App.game.score;

                App.loopId = requestAnimationFrame(App.loop);
            }
        };

        // Init
        window.onload = () => {
            Gfx.init();
            document.getElementById('screen-load').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
            document.getElementById('menu-highscore').innerText = localStorage.getItem('th_highscore') || 0;
        };

    </script>
</body>
</html>
