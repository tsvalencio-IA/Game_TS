<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WII MOTION WEB: SPORTS RESORT</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <style>
        /* EST√âTICA WII / FRUTIGER AERO */
        body {
            background: radial-gradient(circle at center, #ffffff 0%, #e0f7fa 100%);
            margin: 0;
            overflow: hidden;
            font-family: 'Varela Round', sans-serif;
            touch-action: none;
            color: #555;
        }

        /* Camadas */
        #game-container { position: relative; width: 100vw; height: 100vh; }
        
        #webcam {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transform: scaleX(-1); opacity: 0.15; /* Webcam sutil no fundo */
            z-index: 0; pointer-events: none;
        }

        #game-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
        }

        .interactive { pointer-events: auto !important; }

        /* Bot√µes Estilo Wii */
        .wii-btn {
            background: linear-gradient(180deg, #ffffff 0%, #dcdcdc 100%);
            border: 4px solid #4ecdc4;
            border-radius: 50px;
            color: #555;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1), inset 0 2px 5px rgba(255,255,255,1);
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .wii-btn::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.1) 100%);
            border-radius: 45px 45px 100% 100% / 20px;
        }
        .wii-btn:hover { transform: scale(1.05); border-color: #ff6b6b; color: #333; }
        .wii-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Anima√ß√µes */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }
        .hit-effect { position: absolute; border-radius: 50%; border: 5px solid #fff; animation: pulse-ring 0.4s ease-out forwards; }

        /* Health Bars */
        .hp-container { width: 300px; height: 20px; background: #ddd; border-radius: 10px; border: 2px solid #fff; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .hp-bar { height: 100%; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>

    <div id="game-container">
        <video id="video-source" playsinline style="display:none;"></video>
        <video id="webcam" autoplay muted playsinline></video>

        <canvas id="game-canvas"></canvas>

        <div id="ui-layer" class="flex flex-col items-center justify-center">
            
            <div id="screen-loading" class="absolute inset-0 bg-white flex flex-col items-center justify-center interactive z-50">
                <div class="w-24 h-24 border-8 border-gray-200 border-t-cyan-400 rounded-full animate-spin mb-6"></div>
                <h1 class="text-3xl text-gray-600 font-bold mb-2">Ajuste a C√¢mera</h1>
                <p class="text-gray-400 text-lg">Coloque o celular numa mesa e afaste-se 2 metros.</p>
                <p class="text-cyan-500 mt-4 text-sm font-bold animate-pulse">CARREGANDO IA...</p>
            </div>

            <div id="screen-menu" class="hidden absolute inset-0 flex-col items-center justify-center interactive z-40 bg-white/80 backdrop-blur-sm">
                <div class="mb-12 text-center floating">
                    <h1 class="text-6xl md:text-8xl text-cyan-500 font-black tracking-tighter drop-shadow-sm">
                        Wii<span class="text-gray-400">WEB</span>
                    </h1>
                    <p class="text-gray-500 text-xl tracking-widest mt-2 uppercase">Sports Collection</p>
                </div>
                
                <div class="flex flex-col md:flex-row gap-8 w-full max-w-5xl px-8 justify-center items-center">
                    
                    <div onclick="GameSystem.start('box')" class="wii-btn w-64 h-80 flex flex-col items-center justify-center p-6 group">
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">ü•ä</div>
                        <h2 class="text-2xl font-bold mb-2">SUPER BOXE</h2>
                        <p class="text-sm text-gray-500">Soque o oponente!<br>Defenda o rosto!</p>
                        <div class="mt-4 bg-cyan-100 text-cyan-800 text-xs px-2 py-1 rounded-full">NOVO!</div>
                    </div>

                    <div onclick="GameSystem.start('run')" class="wii-btn w-64 h-80 flex flex-col items-center justify-center p-6 group">
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">üèÉ</div>
                        <h2 class="text-2xl font-bold mb-2">ISLAND RUN</h2>
                        <p class="text-sm text-gray-500">Corra no lugar.<br>Desvie com o corpo.</p>
                    </div>

                    <div onclick="GameSystem.start('pose')" class="wii-btn w-64 h-80 flex flex-col items-center justify-center p-6 group">
                        <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">üßò</div>
                        <h2 class="text-2xl font-bold mb-2">ZEN POSE</h2>
                        <p class="text-sm text-gray-500">Encaixe nas formas.<br>Equil√≠brio total.</p>
                    </div>
                </div>
                <p class="mt-10 text-gray-400 text-sm">Use roupas confort√°veis e garanta espa√ßo livre.</p>
            </div>

            <div id="screen-hud" class="hidden absolute inset-0 pointer-events-none p-4 flex flex-col justify-between">
                <div class="flex justify-between items-start w-full">
                    <div id="p1-stats" class="hidden flex-col items-start animate-slide-right">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-10 h-10 rounded-full bg-blue-500 border-2 border-white shadow flex items-center justify-center text-white font-bold">P1</div>
                            <span class="text-blue-600 font-bold bg-white px-3 py-1 rounded-full shadow">VOC√ä</span>
                        </div>
                        <div class="hp-container"><div id="p1-hp" class="hp-bar bg-green-400" style="width: 100%"></div></div>
                    </div>

                    <div class="bg-white/90 px-8 py-2 rounded-b-xl shadow-lg border-t-0 border-4 border-cyan-400 flex flex-col items-center">
                        <span class="text-xs text-gray-400 uppercase tracking-widest font-bold">Pontua√ß√£o</span>
                        <span id="hud-score" class="text-4xl text-cyan-600 font-black">0</span>
                    </div>

                    <div id="cpu-stats" class="hidden flex-col items-end animate-slide-left">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-red-600 font-bold bg-white px-3 py-1 rounded-full shadow">MATT (CPU)</span>
                            <div class="w-10 h-10 rounded-full bg-red-500 border-2 border-white shadow flex items-center justify-center text-white font-bold">CPU</div>
                        </div>
                        <div class="hp-container"><div id="cpu-hp" class="hp-bar bg-yellow-400" style="width: 100%"></div></div>
                    </div>
                </div>

                <div id="hud-message" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center w-full"></div>

                <div class="flex justify-start">
                    <button onclick="GameSystem.stop()" class="interactive bg-white text-gray-500 hover:text-red-500 font-bold py-2 px-6 rounded-full shadow-lg border-2 border-gray-200 transition-colors">
                        ‚è∏ PAUSAR / SAIR
                    </button>
                </div>
            </div>

            <div id="screen-gameover" class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center interactive z-50">
                <h1 id="end-title" class="text-6xl text-cyan-500 font-black mb-4 tracking-tighter">BOM TRABALHO!</h1>
                <div class="bg-blue-50 p-8 rounded-3xl border-4 border-white shadow-xl text-center mb-8">
                    <p class="text-gray-400 text-sm uppercase mb-2">Resultado Final</p>
                    <p class="text-5xl text-gray-700 font-black" id="final-score">0</p>
                    <p class="text-blue-400 font-bold mt-2">Kcal Estimadas: <span id="kcal-score">0</span></p>
                </div>
                <button onclick="GameSystem.showMenu()" class="wii-btn px-12 py-4 text-xl font-bold">
                    Voltar ao Menu
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * =========================================================================
         * ENGINE GR√ÅFICA: "Mii Style"
         * =========================================================================
         */
        const Gfx = {
            // Desenha uma "Luva" ou M√£o estilo Mii (Esferas)
            drawHand: (ctx, x, y, size, color, isClosed = true) => {
                ctx.save();
                ctx.translate(x, y);
                
                // Sombra
                ctx.beginPath();
                ctx.arc(5, 5, size, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.fill();

                // Base da Luva
                ctx.beginPath();
                ctx.arc(0, 0, size, 0, Math.PI*2);
                const grad = ctx.createRadialGradient(-size/3, -size/3, size/5, 0, 0, size);
                grad.addColorStop(0, '#fff');
                grad.addColorStop(1, color);
                ctx.fillStyle = grad;
                ctx.fill();
                
                // Detalhe de brilho pl√°stico
                ctx.beginPath();
                ctx.arc(-size/3, -size/3, size/4, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.fill();

                // Outline
                ctx.strokeStyle = 'rgba(0,0,0,0.1)';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.restore();
            },

            // Desenha a cabe√ßa flutuante do oponente
            drawHead: (ctx, x, y, size, color, hitFrame) => {
                ctx.save();
                ctx.translate(x, y);
                if (hitFrame > 0) {
                    ctx.translate((Math.random()-0.5)*20, (Math.random()-0.5)*20); // Shake
                }

                // Cabe√ßa
                ctx.beginPath();
                ctx.arc(0, 0, size, 0, Math.PI*2);
                const grad = ctx.createRadialGradient(-10, -10, 5, 0, 0, size);
                grad.addColorStop(0, '#ffe0bd'); // Pele
                grad.addColorStop(1, '#ffcd94');
                ctx.fillStyle = grad;
                ctx.fill();

                // Rosto (Olhos e Boca simples estilo Mii)
                ctx.fillStyle = '#333';
                if (hitFrame > 0) {
                    // Cara de dor >_<
                    ctx.font = `${size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(">_<", 0, 0);
                } else {
                    // Cara normal
                    ctx.beginPath();
                    ctx.arc(-20, -10, 5, 0, Math.PI*2); // Olho Esq
                    ctx.arc(20, -10, 5, 0, Math.PI*2);  // Olho Dir
                    ctx.fill();
                    ctx.beginPath();
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#333';
                    ctx.arc(0, 20, 10, 0, Math.PI, false); // Sorriso
                    ctx.stroke();
                }

                ctx.restore();
            }
        };

        /**
         * =========================================================================
         * MOTION ENGINE (TensorFlow Wrapper)
         * =========================================================================
         */
        class MotionEngine {
            constructor() {
                this.detector = null;
                this.video = document.getElementById('video-source');
                this.webcamDisplay = document.getElementById('webcam');
                this.ready = false;
            }

            async init() {
                await tf.setBackend('webgl');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });
                this.video.srcObject = stream;
                this.webcamDisplay.srcObject = stream;

                await new Promise(r => this.video.onloadedmetadata = r);
                this.video.play();

                const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
                this.detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, detectorConfig);
                
                this.ready = true;
            }

            async getPose() {
                if (!this.ready) return null;
                try {
                    const poses = await this.detector.estimatePoses(this.video);
                    if (poses.length > 0) return poses[0];
                } catch (e) { console.error(e); }
                return null;
            }
        }

        /**
         * =========================================================================
         * JOGO 1: BOXE (Novo - Estilo Knockout)
         * =========================================================================
         */
        class GameBox {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.score = 0;
                
                this.p1HP = 100;
                this.cpuHP = 100;
                this.state = 'fight'; // intro, fight, win, lose
                this.msgTimer = 0;

                // Estado F√≠sico
                this.hands = { left: {x:0, y:0, z:0}, right: {x:0, y:0, z:0} };
                this.lastHands = { left: {y:0}, right: {y:0} };
                
                // CPU AI
                this.cpu = {
                    x: canvas.width / 2,
                    y: canvas.height / 2 - 50,
                    state: 'idle', // idle, attack, dizzy
                    actionTimer: 0,
                    hitFrame: 0
                };
            }

            start() {
                this.score = 0;
                this.p1HP = 100;
                this.cpuHP = 100;
                this.state = 'fight';
                document.getElementById('p1-stats').classList.remove('hidden');
                document.getElementById('p1-stats').classList.add('flex');
                document.getElementById('cpu-stats').classList.remove('hidden');
                document.getElementById('cpu-stats').classList.add('flex');
                this.setMsg("GUARDA ALTA!", "green");
            }

            setMsg(text, color) {
                const el = document.getElementById('hud-message');
                el.innerHTML = `<h2 class="text-4xl font-black text-${color}-500 drop-shadow-md animate-bounce">${text}</h2>`;
                setTimeout(() => { if(el.innerText === text) el.innerHTML = ''; }, 2000);
            }

            update(pose) {
                const w = this.canvas.width;
                const h = this.canvas.height;
                this.cpu.x = w / 2;
                this.cpu.y = h / 2;

                if (this.state !== 'fight') {
                    this.draw(w, h, pose);
                    return this.score;
                }

                // 1. Processar Player
                let isGuarding = false;
                let isPunching = false;

                if (pose) {
                    const kp = pose.keypoints;
                    const find = n => kp.find(k => k.name === n);
                    const nose = find('nose');
                    const lw = find('left_wrist');
                    const rw = find('right_wrist');
                    const ls = find('left_shoulder');

                    if (nose && lw && rw) {
                        // Coordenadas normalizadas para Canvas
                        const mapX = (val) => (1 - val/640) * w;
                        const mapY = (val) => (val/480) * h;

                        // Atualizar Posi√ß√£o Visual das M√£os
                        this.hands.left.x = mapX(lw.x);
                        this.hands.left.y = mapY(lw.y);
                        this.hands.right.x = mapX(rw.x);
                        this.hands.right.y = mapY(rw.y);

                        // L√≥gica de Guarda: M√£os perto do rosto
                        const guardDist = w * 0.15; // 15% da tela
                        const lDistNose = Math.abs(this.hands.left.x - mapX(nose.x));
                        const rDistNose = Math.abs(this.hands.right.x - mapX(nose.x));
                        
                        // Se m√£os est√£o altas e perto do centro horizontal
                        if (this.hands.left.y < mapY(nose.y) + 100 && this.hands.right.y < mapY(nose.y) + 100) {
                             if (lDistNose < guardDist && rDistNose < guardDist) {
                                 isGuarding = true;
                             }
                        }

                        // L√≥gica de Soco: Velocidade + Extens√£o
                        // Detectar soco r√°pido: Y da m√£o sobe (no video y=0 √© topo) ou sai de perto do ombro
                        const punchThreshold = 20; // Pixel diff
                        const leftPunch = (this.lastHands.left.y - lw.y) > punchThreshold; // Movimento r√°pido pra cima
                        const rightPunch = (this.lastHands.right.y - rw.y) > punchThreshold;

                        // Dist√¢ncia para o CPU
                        const hitDist = 150;
                        const lHit = Math.hypot(this.hands.left.x - this.cpu.x, this.hands.left.y - this.cpu.y) < hitDist;
                        const rHit = Math.hypot(this.hands.right.x - this.cpu.x, this.hands.right.y - this.cpu.y) < hitDist;

                        if ((leftPunch || rightPunch) && (lHit || rHit)) {
                            // SOCO CONECTADO!
                            this.cpuHP -= 5;
                            this.score += 100;
                            this.cpu.hitFrame = 10;
                            this.setMsg("BAM!", "orange");
                            
                            // Visual Spark
                            const hx = lHit ? this.hands.left.x : this.hands.right.x;
                            const hy = lHit ? this.hands.left.y : this.hands.right.y;
                            this.createSpark(hx, hy);
                        }

                        this.lastHands.left.y = lw.y;
                        this.lastHands.right.y = rw.y;
                    }
                }

                // 2. Processar CPU (AI Simples)
                this.cpu.actionTimer++;
                if (this.cpu.hitFrame > 0) this.cpu.hitFrame--;

                // Ciclo: Idle -> Prepara -> Soca -> Idle
                if (this.cpu.actionTimer > 150) { // A cada ~2.5 segundos
                     // CPU Ataca!
                     if (!isGuarding) {
                         this.p1HP -= 15;
                         this.setMsg("DANO!", "red");
                         // Efeito de tela vermelha
                         this.canvas.style.backgroundColor = 'rgba(255,0,0,0.3)';
                         setTimeout(() => this.canvas.style.backgroundColor = 'transparent', 100);
                     } else {
                         this.setMsg("BLOQUEADO!", "blue");
                         this.score += 50; // Recompensa por bloquear
                     }
                     this.cpu.actionTimer = 0;
                }

                // Atualizar Barras de Vida UI
                document.getElementById('p1-hp').style.width = this.p1HP + '%';
                document.getElementById('cpu-hp').style.width = this.cpuHP + '%';

                // Checar Vit√≥ria/Derrota
                if (this.cpuHP <= 0) GameSystem.gameOver(this.score, "KO! VIT√ìRIA!");
                if (this.p1HP <= 0) GameSystem.gameOver(this.score, "TKO! TENTE DE NOVO");

                this.draw(w, h, pose, isGuarding);
                return this.score;
            }

            createSpark(x, y) {
                // Simples efeito visual de impacto
                const el = document.createElement('div');
                el.className = 'hit-effect';
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.style.width = '100px';
                el.style.height = '100px';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 400);
            }

            draw(w, h, pose, guarding) {
                this.ctx.clearRect(0,0,w,h);

                // Desenhar CPU
                // Corpo
                this.ctx.fillStyle = '#dcdcdc';
                this.ctx.fillRect(this.cpu.x - 40, this.cpu.y + 50, 80, 200);
                // Cabe√ßa
                Gfx.drawHead(this.ctx, this.cpu.x, this.cpu.y, 60, 'red', this.cpu.hitFrame);
                // Luvas CPU
                const cpuPunching = this.cpu.actionTimer > 130;
                const gloveScale = cpuPunching ? 1.5 : 1; // Luva cresce quando ataca
                const gloveY = cpuPunching ? h/2 + 100 : h/2 + 50;
                
                Gfx.drawHand(this.ctx, this.cpu.x - 50 * gloveScale, gloveY, 40 * gloveScale, '#ff4444');
                Gfx.drawHand(this.ctx, this.cpu.x + 50 * gloveScale, gloveY, 40 * gloveScale, '#ff4444');

                // Aviso de Ataque
                if (this.cpu.actionTimer > 100) {
                    this.ctx.fillStyle = 'rgba(255,0,0,0.2)';
                    this.ctx.beginPath();
                    this.ctx.arc(this.cpu.x, this.cpu.y, 100, 0, Math.PI*2);
                    this.ctx.fill();
                }

                // Desenhar PLAYER (Luvas Azuis)
                if (pose) {
                    const color = guarding ? '#4ecdc4' : '#00a8ff'; // Muda cor se estiver defendendo
                    Gfx.drawHand(this.ctx, this.hands.left.x, this.hands.left.y, 50, color);
                    Gfx.drawHand(this.ctx, this.hands.right.x, this.hands.right.y, 50, color);
                }
            }
        }

        /**
         * =========================================================================
         * JOGO 2: RUNNER (Atualizado para Mii)
         * =========================================================================
         */
        class GameRun {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.score = 0;
                this.playerY = 0;
                this.runSpeed = 0;
                this.lane = 0;
                this.obstacles = [];
                this.distance = 0;
            }

            start() {
                this.score = 0;
                this.obstacles = [];
                this.runSpeed = 0;
                this.setMsg("CORRA NO LUGAR!");
            }

            setMsg(txt) {
                 document.getElementById('hud-message').innerHTML = `<h2 class="text-3xl font-black text-cyan-600 drop-shadow-md">${txt}</h2>`;
            }

            update(pose) {
                const w = this.canvas.width;
                const h = this.canvas.height;

                // Input de Corrida (Bounce do nariz)
                if (pose) {
                    const nose = pose.keypoints.find(k => k.name === 'nose');
                    if (nose) {
                        const delta = Math.abs(nose.y - this.playerY);
                        if (delta > 2) this.runSpeed += delta * 0.2;
                        this.playerY = nose.y;

                        // Pista (Baseado na posi√ß√£o X do nariz na webcam)
                        if (nose.x < 200) this.lane = -1; // Esq
                        else if (nose.x > 440) this.lane = 1; // Dir
                        else this.lane = 0;
                    }
                }

                // F√≠sica
                this.runSpeed *= 0.95; // Atrito
                this.distance += this.runSpeed;
                this.score = Math.floor(this.distance / 100);

                // Obst√°culos
                if (Math.random() < 0.02 && this.runSpeed > 5) {
                    this.obstacles.push({ lane: Math.floor(Math.random()*3)-1, z: 1000 });
                }

                this.obstacles.forEach((obs, i) => {
                    obs.z -= (this.runSpeed + 10);
                    if (obs.z < 50 && obs.z > -50 && obs.lane === this.lane) {
                        this.runSpeed = 0; // Colis√£o
                        this.setMsg("CUIDADO!");
                        this.score -= 50;
                        this.obstacles.splice(i, 1);
                    }
                });

                this.draw(w, h);
                return this.score;
            }

            draw(w, h) {
                this.ctx.clearRect(0,0,w,h);
                const cx = w/2;
                const cy = h/2 - 100;

                // C√©u e Ch√£o estilo Wii Sports Resort
                const gradSky = this.ctx.createLinearGradient(0,0,0,cy);
                gradSky.addColorStop(0, '#87CEEB'); // Azul c√©u
                gradSky.addColorStop(1, '#E0F7FA');
                this.ctx.fillStyle = gradSky;
                this.ctx.fillRect(0,0,w,cy);

                this.ctx.fillStyle = '#a8e6cf'; // Grama
                this.ctx.fillRect(0,cy,w,h-cy);

                // Pista de Corrida
                this.ctx.fillStyle = '#f7d794'; // Areia
                this.ctx.beginPath();
                this.ctx.moveTo(cx - 20, cy);
                this.ctx.lineTo(cx + 20, cy);
                this.ctx.lineTo(cx + w/2, h);
                this.ctx.lineTo(cx - w/2, h);
                this.ctx.fill();

                // Obst√°culos (Pedras)
                this.obstacles.forEach(obs => {
                    if(obs.z < 1) return;
                    const scale = 500 / obs.z;
                    const ox = cx + (obs.lane * 300 * scale);
                    const oy = cy + (200 * scale);
                    
                    this.ctx.fillStyle = '#7f8c8d';
                    this.ctx.beginPath();
                    this.ctx.arc(ox, oy, 40 * scale, 0, Math.PI, true);
                    this.ctx.fill();
                });

                // Jogador (Cabe√ßa Mii de costas)
                const px = cx + (this.lane * 150);
                const bob = Math.sin(Date.now()/100) * (this.runSpeed);
                Gfx.drawHead(this.ctx, px, h - 150 + bob, 40, '#333', 0);
            }
        }

        /**
         * =========================================================================
         * JOGO 3: POSE (Estilo Zen)
         * =========================================================================
         */
        class GamePose {
             constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.score = 0;
                this.target = { x: 0, y: 0, active: false };
            }
            start() { this.score = 0; this.spawnTarget(); }
            
            spawnTarget() {
                this.target = {
                    x: Math.random() * (this.canvas.width - 100) + 50,
                    y: Math.random() * (this.canvas.height - 200) + 50,
                    active: true,
                    birth: Date.now()
                };
            }

            update(pose) {
                if (!this.target.active) this.spawnTarget();
                const w = this.canvas.width;
                const h = this.canvas.height;

                if (pose) {
                    const wrists = [pose.keypoints[9], pose.keypoints[10]]; // Pulsos
                    wrists.forEach(wrist => {
                        if(wrist.score > 0.3) {
                            const wx = (1 - wrist.x/640) * w;
                            const wy = (wrist.y/480) * h;
                            const dist = Math.hypot(wx - this.target.x, wy - this.target.y);
                            
                            if (dist < 60) {
                                this.score += 100;
                                this.target.active = false;
                                // Part√≠culas
                                const el = document.getElementById('hud-message');
                                el.innerHTML = `<span class="text-pink-400 font-bold text-2xl animate-ping">PERFEITO!</span>`;
                            }
                        }
                    });
                }
                
                // Timeout do alvo
                if (Date.now() - this.target.birth > 3000) this.target.active = false;

                this.draw(w, h, pose);
                return this.score;
            }

            draw(w, h, pose) {
                this.ctx.clearRect(0,0,w,h);
                
                // Desenhar Alvo (Bolha Zen)
                if (this.target.active) {
                    this.ctx.beginPath();
                    this.ctx.arc(this.target.x, this.target.y, 50, 0, Math.PI*2);
                    this.ctx.fillStyle = 'rgba(255, 105, 180, 0.6)';
                    this.ctx.fill();
                    this.ctx.lineWidth = 4;
                    this.ctx.strokeStyle = '#fff';
                    this.ctx.stroke();
                    this.ctx.fillStyle = '#fff';
                    this.ctx.font = "20px Varela Round";
                    this.ctx.fillText("TOQUE", this.target.x - 35, this.target.y + 5);
                }

                // Linhas do corpo
                if (pose) {
                    this.ctx.strokeStyle = 'white';
                    this.ctx.lineWidth = 8;
                    this.ctx.lineCap = 'round';
                    // Simplificado para arte
                    const points = pose.keypoints;
                    const draw = (i1, i2) => {
                        if(points[i1].score > 0.3 && points[i2].score > 0.3) {
                             const x1 = (1 - points[i1].x/640)*w; const y1 = (points[i1].y/480)*h;
                             const x2 = (1 - points[i2].x/640)*w; const y2 = (points[i2].y/480)*h;
                             this.ctx.beginPath(); this.ctx.moveTo(x1, y1); this.ctx.lineTo(x2, y2); this.ctx.stroke();
                        }
                    }
                    draw(5, 7); draw(7, 9); // Bra√ßo Esq
                    draw(6, 8); draw(8, 10); // Bra√ßo Dir
                    draw(5, 6); // Ombros
                }
            }
        }

        /**
         * =========================================================================
         * SISTEMA PRINCIPAL
         * =========================================================================
         */
        const GameSystem = {
            motion: new MotionEngine(),
            canvas: document.getElementById('game-canvas'),
            activeGame: null,
            loopId: null,

            init: async () => {
                const resize = () => {
                    GameSystem.canvas.width = window.innerWidth;
                    GameSystem.canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                await GameSystem.motion.init();
                
                document.getElementById('screen-loading').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                document.getElementById('screen-menu').classList.add('flex');
            },

            start: (type) => {
                document.getElementById('screen-menu').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('flex');
                document.getElementById('screen-hud').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('hidden');

                if (type === 'box') GameSystem.activeGame = new GameBox(GameSystem.canvas);
                if (type === 'run') GameSystem.activeGame = new GameRun(GameSystem.canvas);
                if (type === 'pose') GameSystem.activeGame = new GamePose(GameSystem.canvas);

                GameSystem.activeGame.start();
                GameSystem.loop();
            },

            stop: () => {
                cancelAnimationFrame(GameSystem.loopId);
                GameSystem.activeGame = null;
                GameSystem.showMenu();
            },

            gameOver: (score, title = "FIM DE JOGO") => {
                cancelAnimationFrame(GameSystem.loopId);
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-gameover').classList.remove('hidden');
                document.getElementById('screen-gameover').classList.add('flex');
                
                document.getElementById('end-title').innerText = title;
                document.getElementById('final-score').innerText = score;
                document.getElementById('kcal-score').innerText = (score * 0.05).toFixed(1); // C√°lculo fake de Kcal
            },

            showMenu: () => {
                document.getElementById('screen-hud').classList.add('hidden');
                document.getElementById('screen-gameover').classList.add('hidden');
                document.getElementById('screen-menu').classList.remove('hidden');
                document.getElementById('screen-menu').classList.add('flex');
                
                // Reset stats UI
                document.getElementById('p1-stats').classList.add('hidden');
                document.getElementById('cpu-stats').classList.add('hidden');
                
                const ctx = GameSystem.canvas.getContext('2d');
                ctx.clearRect(0,0, GameSystem.canvas.width, GameSystem.canvas.height);
            },

            loop: async () => {
                if (!GameSystem.activeGame) return;

                const pose = await GameSystem.motion.getPose();
                const score = GameSystem.activeGame.update(pose);
                
                document.getElementById('hud-score').innerText = score;
                GameSystem.loopId = requestAnimationFrame(GameSystem.loop);
            }
        };

        window.onload = GameSystem.init;

    </script>
</body>
</html>
